<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채팅 - hub</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .chat-layout { display:grid; grid-template-columns: 320px 1fr; gap:16px; padding: 24px 0; align-items: start; }
        .panel { background:#fff; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.05); }
        .panel-header { padding:14px 16px; border-bottom:1px solid #eee; font-weight:700; }
        .panel-body { padding:16px; }
        .room-list { list-style:none; }
        .room-list li { padding:10px 12px; border-radius:10px; cursor:pointer; }
        .room-list li:hover { background:#FFF0E5; }
        .room-list li.active { background:var(--primary-color); color:white; }
        .messages { height: 480px; overflow:auto; display:flex; flex-direction:column; gap:10px; }
        .msg { max-width: 70%; padding:10px 12px; border-radius:12px; background:#f7f7f7; }
        .msg.me { align-self:flex-end; background: var(--primary-color); color:#fff; }
        .composer { display:flex; gap:8px; margin-top:12px; }
        .composer input { flex:1; padding:12px 14px; border:1px solid #eee; border-radius:10px; }
        .matching-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media(max-width: 900px){ .chat-layout{ grid-template-columns:1fr; } }
    </style>
</head>
<body>
    <header id="main-header">
        <nav class="container">
            <div class="logo">
                <a href="index.html"><img src="logo.png" alt="Hub Logo" style="height:64px; vertical-align:middle; margin-right:8px;"></a>
            </div>
            <ul class="nav-links">
                <li><a href="index.html#features">서비스 소개</a></li>
                <li>
                <a href="chat.html">랜덤 매칭</a>
                    <div class="dropdown-menu">
                        <a href="chat.html#random">랜덤 1대1 채팅</a>
                        <a href="chat.html#group">그룹 채팅</a>
                    </div>
                </li>
                <li>
                    <a href="boards.html">게시판</a>
                    <div class="dropdown-menu">
                        <a href="boards.html#ai">AI융합부</a>
                        <a href="boards.html#bible">성서학과</a>
                        <a href="boards.html#nursing">간호학과</a>
                        <a href="boards.html#child">영유아보육학과</a>
                        <a href="boards.html#social">사회복지학과</a>
                    </div>
                </li>
                <li><a href="mypage.html">마이페이지</a></li>
            </ul>
            <div class="auth-buttons">
                <a href="login.html" class="btn btn-secondary">로그인</a>
                <a href="signup.html" class="btn btn-primary">회원가입</a>
            </div>
        </nav>
    </header>

    <main class="container">
        <section id="anon-setup" class="panel" style="max-width:860px; margin:24px auto;">
            <div class="panel-header">익명 프로필 설정</div>
            <div class="panel-body">
                <form id="anon-form">
                    <div class="field">
                        <label>몇 학번인가요?</label>
                        <select id="ap_year" style="width:100%; padding:12px 14px; border:1px solid #eee; border-radius:10px;">
                            <option value="">선택</option>
                            <option>25학번</option>
                            <option>24학번</option>
                            <option>23학번</option>
                            <option>22학번</option>
                            <option>21학번</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>성별 선택(공개 기준)</label>
                        <div class="segmented">
                            <button type="button" class="btn active" data-gender="남자">남자</button>
                            <button type="button" class="btn" data-gender="여자">여자</button>
                        </div>
                    </div>
                    <div class="field">
                        <label>닉네임 (최대 20자)</label>
                        <input type="text" id="ap_nickname" maxlength="20" placeholder="예) 익명의친구" style="width:100%; padding:12px 14px; border:1px solid #eee; border-radius:10px;">
                        <div class="helper"><span id="ap_nickname_count">0</span> / 20</div>
                    </div>
                    <div class="field">
                        <label>자기소개 (최대 100자)</label>
                        <textarea id="ap_bio" rows="4" maxlength="100" placeholder="예) 사람 만나 얘기하는 거 좋아해요. 영화/카페/산책 좋아합니다." style="width:100%; padding:12px 14px; border:1px solid #eee; border-radius:10px;"></textarea>
                        <div class="helper"><span id="ap_count">0</span> / 100</div>
                    </div>
                    <div class="field">
                        <label>관심사 선택</label>
                        <div id="ap_interests">
                            <span class="chip" data-value="영화">영화</span>
                            <span class="chip" data-value="운동">운동</span>
                            <span class="chip" data-value="게임">게임</span>
                            <span class="chip" data-value="음악">음악</span>
                            <span class="chip" data-value="카페">카페</span>
                            <span class="chip" data-value="여행">여행</span>
                            <span class="chip" data-value="스터디">스터디</span>
                            <span class="chip" data-value="독서">독서</span>
                            <span class="chip" data-value="맛집">맛집</span>
                        </div>
                        <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
                            <div style="flex:1"></div>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; margin-top:4px;">
                        <button type="submit" class="btn btn-primary" style="flex: 0 0 80%;">임시 저장</button>
                        <button type="button" class="btn btn-secondary" id="ap_reset" style="flex: 0 0 20%;">리셋</button>
                    </div>
                    <div class="helper">* 이 페이지는 시안용입니다. 실제 서비스에서는 이메일 인증 후 저장됩니다.</div>
                </form>
            </div>
        </section>
        <div class="chat-layout" id="chat-ui" style="display:none;">
            <aside class="panel">
                <div class="panel-header">채팅방 목록</div>
                <div class="panel-body">
                    <h4 style="margin:10px 0 6px;">1:1</h4>
                    <ul class="room-list" id="dmList">
                        <!-- 관심분야 기반으로 자동 생성 -->
                    </ul>
                    <h4 style="margin:16px 0 6px;">그룹</h4>
                    <ul class="room-list" id="groupList">
                        <!-- 생성 시 표시 -->
                    </ul>
                    <h4 style="margin:16px 0 6px;">관심 분야</h4>
                    <ul class="room-list" id="interestList">
                        <!-- 선택한 관심사 목록 -->
                    </ul>
                </div>
            </aside>
            <section class="panel">
                <div class="panel-header" id="chatHeader">채팅방을 선택해주세요</div>
                <div class="panel-body">
                    <div id="chatContent">
                        <div id="profileCard" style="display:flex; align-items:center; gap:14px; padding:12px; border:1px solid #eee; border-radius:12px; margin-bottom:12px;">
                            <div style="width:56px; height:56px; border-radius:50%; background:#f0f0f0; display:flex; align-items:center; justify-content:center; font-size:28px;">👤</div>
                        <div style="flex:1;">
                            <div id="cardNickname" style="font-weight:800;">익명 프로필</div>
                            <div id="cardMeta" style="font-size:0.9rem; color:#666;"></div>
                            <div id="cardBio" style="margin-top:4px;"></div>
                        </div>
                        </div>

                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                            <div class="panel" style="box-shadow:none; border:1px solid #eee;">
                                <div class="panel-body">
                                    <div style="font-weight:800; margin-bottom:6px;">랜덤 1:1 대화</div>
                                    <div style="font-size:0.9rem; color:#777;">익명으로 한 명과 연결됩니다.</div>
                                    <div style="margin-top:8px;">
                                        <button id="startRandom" class="btn btn-primary" style="width:100%;">1:1 매칭 시작하기</button>
                                        <div id="randomMatchingStatus" style="display:none; text-align:center; margin-top:12px;">
                                            <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:8px;">
                                                <div class="matching-spinner"></div>
                                                <span style="font-weight:600; color:var(--primary-color);">매칭 중...</span>
                                            </div>
                                            <div id="randomTimer" style="font-size:0.9rem; color:#666;">00:00:00</div>
                                            <button id="cancelRandom" class="btn btn-secondary" style="margin-top:8px; width:100%;">매칭 취소</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="panel" style="box-shadow:none; border:1px solid #eee;">
                                <div class="panel-body">
                                    <div style="font-weight:800; margin-bottom:6px;">랜덤 그룹 대화</div>
                                    <div style="font-size:0.9rem; color:#777;">3-6명이 랜덤으로 모여 대화합니다.</div>
                                    <div style="margin-top:8px;">
                                        <button id="startGroup" class="btn btn-primary" style="width:100%;">그룹 매칭 시작하기</button>
                                        <div id="groupMatchingStatus" style="display:none; text-align:center; margin-top:12px;">
                                            <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:8px;">
                                                <div class="matching-spinner"></div>
                                                <span style="font-weight:600; color:var(--primary-color);">매칭 중...</span>
                                            </div>
                                            <div id="groupTimer" style="font-size:0.9rem; color:#666;">00:00:00</div>
                                            <button id="cancelGroup" class="btn btn-secondary" style="margin-top:8px; width:100%;">매칭 취소</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 실제 채팅 화면 -->
                    <div id="chatRoom" style="display:none;">
                        <div class="messages" id="messages">
                            <!-- 채팅 메시지들이 여기에 표시됨 -->
                        </div>
                        <div class="composer">
                            <input type="text" id="messageInput" placeholder="메시지를 입력하세요...">
                            <button id="sendButton" class="btn btn-primary">전송</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 KBU Hub. All Rights Reserved.</p>
        </div>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', function(){
        // 카드 표시
        function renderCard(){
            const a = loadAnon();
            const meta = [];
            if(a?.year) meta.push(a.year);
            if(a?.gender) meta.push(a.gender);
            document.getElementById('cardMeta').textContent = meta.join(' · ');
            document.getElementById('cardBio').textContent = a?.bio || '';
            
            // 닉네임 표시 (프로필 카드의 제목 부분)
            document.getElementById('cardNickname').textContent = a?.nickname || '익명 프로필';
        }
        renderCard();
        
        // 로그인 상태 확인 (실제로는 서버에서 확인해야 함)
        function isLoggedIn(){
            // 시연용: 로그인 상태를 localStorage에서 확인
            return localStorage.getItem('isLoggedIn') === 'true';
        }
        
        // 익명카드 로드/표시
        function loadAnon(){
            // 로그인이 안되어 있으면 익명카드 로드 안함
            if (!isLoggedIn()) return null;
            try { return JSON.parse(localStorage.getItem('anonProfile')||'null'); } catch(e){ return null; }
        }
        function hasAnon(){ 
            // 로그인이 안되어 있으면 익명카드가 없다고 판단
            if (!isLoggedIn()) return false;
            const a = loadAnon(); 
            return a && a.year; 
        }
        function toggleUI(){
            const chat = document.getElementById('chat-ui');
            const setup = document.getElementById('anon-setup');
            if(hasAnon()){ 
                chat.style.display='grid'; 
                setup.style.display='none'; 
            } else { 
                chat.style.display='none'; 
                setup.style.display='block'; 
            }
        }
        toggleUI();

        // form handlers
        const form = document.getElementById('anon-form');
        const bio = document.getElementById('ap_bio');
        const count = document.getElementById('ap_count');
        const nickname = document.getElementById('ap_nickname');
        const nicknameCount = document.getElementById('ap_nickname_count');
        
        bio.addEventListener('input', ()=>{ count.textContent = bio.value.length; });
        nickname.addEventListener('input', ()=>{ nicknameCount.textContent = nickname.value.length; });
        const genderBtns = Array.from(document.querySelectorAll('[data-gender]'));
        genderBtns.forEach(btn=>btn.addEventListener('click', ()=>{
            genderBtns.forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
        }));
        const chips = document.getElementById('ap_interests');
        chips.addEventListener('click', (e)=>{
            if(e.target.classList.contains('chip')){ e.target.classList.toggle('selected'); }
        });
        // 사용자 직접 입력 제거됨
        document.getElementById('ap_reset').addEventListener('click', ()=>{
            Array.from(chips.querySelectorAll('.chip')).forEach(c=>c.classList.remove('selected'));
            bio.value=''; count.textContent='0';
            nickname.value=''; nicknameCount.textContent='0';
            document.getElementById('ap_year').value='';
            genderBtns.forEach(b=>b.classList.remove('active'));
            genderBtns[0].classList.add('active');
        });
        form.addEventListener('submit', (e)=>{
            e.preventDefault();
            
            // 로그인 상태 확인
            if (!isLoggedIn()) {
                alert('익명 프로필을 저장하려면 먼저 로그인해주세요.');
                return;
            }
            
            const year = document.getElementById('ap_year').value;
            const gender = (genderBtns.find(b=>b.classList.contains('active'))||{}).dataset?.gender || '남자';
            const nicknameValue = nickname.value.trim() || '익명의친구';
            const interests = Array.from(chips.querySelectorAll('.chip.selected')).map(c=>c.dataset.value);
            const profile = { year, gender, nickname: nicknameValue, bio: bio.value.trim(), interests };
            localStorage.setItem('anonProfile', JSON.stringify(profile));
            toggleUI();
            renderCard();
            alert('익명 프로필이 저장되었습니다. 이제 매칭을 시작할 수 있습니다!');
        });

        // 관심 분야 목록 표시 및 채팅방 생성
        function renderInterestList(){
            const interestList = document.getElementById('interestList');
            if(!interestList) return;
            interestList.innerHTML = '';
            const a = loadAnon();
            (a?.interests || []).forEach(topic => {
                const li = document.createElement('li');
                li.textContent = topic;
                li.addEventListener('click', ()=>{
                    // 클릭한 관심사 항목을 채팅방으로 변환
                    enterInterestChatRoom(li, topic);
                });
                interestList.appendChild(li);
            });
            if(interestList.children.length === 0){
                const li2 = document.createElement('li');
                li2.style.color = '#777';
                li2.textContent = '선택한 관심분야가 없습니다.';
                interestList.appendChild(li2);
            }
        }

        // 관심사 채팅방 입장 (기존 항목을 채팅방으로 변환)
        function enterInterestChatRoom(liElement, topic) {
            const roomName = `관심사 · ${topic}`;
            
            // 텍스트는 그대로 유지하고 채팅방 입장만
            enterRoom(roomName);
        }
        renderInterestList();

        // 매칭 상태 관리
        let randomMatching = false;
        let groupMatching = false;
        let randomStartTime = null;
        let groupStartTime = null;
        let randomTimer = null;
        let groupTimer = null;

        const btnStartRandom = document.getElementById('startRandom');
        const btnStartGroup = document.getElementById('startGroup');
        const randomMatchingStatus = document.getElementById('randomMatchingStatus');
        const groupMatchingStatus = document.getElementById('groupMatchingStatus');
        const randomTimerEl = document.getElementById('randomTimer');
        const groupTimerEl = document.getElementById('groupTimer');
        const cancelRandom = document.getElementById('cancelRandom');
        const cancelGroup = document.getElementById('cancelGroup');
        const dmList = document.getElementById('dmList');
        const groupList = document.getElementById('groupList');

        // 타이머 포맷팅 함수
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // 1:1 매칭 시작
        function startRandomMatching() {
            // 익명카드가 없으면 설정 화면 표시
            if (!hasAnon()) {
                const chat = document.getElementById('chat-ui');
                const setup = document.getElementById('anon-setup');
                chat.style.display = 'none';
                setup.style.display = 'block';
                alert('매칭을 시작하려면 먼저 익명 프로필을 설정해주세요.');
                return;
            }

            randomMatching = true;
            randomStartTime = Date.now();
            btnStartRandom.style.display = 'none';
            randomMatchingStatus.style.display = 'block';
            
            randomTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - randomStartTime) / 1000);
                randomTimerEl.textContent = formatTime(elapsed);
            }, 1000);

            // 실제 서비스에서는 서버에서 매칭 완료 신호를 받을 때까지 무한정 대기
            // 매칭이 잡힐 때까지 계속 시간이 흘러감
            // 서버에서 매칭 완료 시 completeRandomMatching() 함수를 호출해야 함
        }

        // 그룹 매칭 시작
        function startGroupMatching() {
            // 익명카드가 없으면 설정 화면 표시
            if (!hasAnon()) {
                const chat = document.getElementById('chat-ui');
                const setup = document.getElementById('anon-setup');
                chat.style.display = 'none';
                setup.style.display = 'block';
                alert('매칭을 시작하려면 먼저 익명 프로필을 설정해주세요.');
                return;
            }

            groupMatching = true;
            groupStartTime = Date.now();
            btnStartGroup.style.display = 'none';
            groupMatchingStatus.style.display = 'block';
            
            groupTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - groupStartTime) / 1000);
                groupTimerEl.textContent = formatTime(elapsed);
            }, 1000);

            // 실제 서비스에서는 서버에서 매칭 완료 신호를 받을 때까지 무한정 대기
            // 매칭이 잡힐 때까지 계속 시간이 흘러감
            // 서버에서 매칭 완료 시 completeGroupMatching() 함수를 호출해야 함
        }

        // 1:1 매칭 완료
        function completeRandomMatching() {
            randomMatching = false;
            clearInterval(randomTimer);
            btnStartRandom.style.display = 'block';
            randomMatchingStatus.style.display = 'none';
            
            // 랜덤 닉네임 생성
            const nicknames = ['익명의친구', '익명의학생', '익명의동료', '익명의친구1', '익명의학생1', '익명의동료1'];
            const randomNickname = nicknames[Math.floor(Math.random() * nicknames.length)];
            
            createRoom(dmList, `랜덤 1:1 · ${randomNickname}`);
            
            alert('매칭이 완료되었습니다! 채팅방이 생성되었어요.');
        }

        // 그룹 매칭 완료
        function completeGroupMatching() {
            groupMatching = false;
            clearInterval(groupTimer);
            btnStartGroup.style.display = 'block';
            groupMatchingStatus.style.display = 'none';
            
            // 그룹 번호 생성 (1부터 시작)
            const groupNumber = document.querySelectorAll('#groupList li').length + 1;
            createRoom(groupList, `랜덤 그룹 · 그룹 ${groupNumber}`);
            
            alert('그룹 매칭이 완료되었습니다! 채팅방이 생성되었어요.');
        }

        // 매칭 취소
        function cancelRandomMatching() {
            randomMatching = false;
            clearInterval(randomTimer);
            btnStartRandom.style.display = 'block';
            randomMatchingStatus.style.display = 'none';
        }

        function cancelGroupMatching() {
            groupMatching = false;
            clearInterval(groupTimer);
            btnStartGroup.style.display = 'block';
            groupMatchingStatus.style.display = 'none';
        }

        // 이벤트 리스너
        btnStartRandom.addEventListener('click', startRandomMatching);
        btnStartGroup.addEventListener('click', startGroupMatching);
        cancelRandom.addEventListener('click', cancelRandomMatching);
        cancelGroup.addEventListener('click', cancelGroupMatching);

        // 현재 활성 채팅방
        let currentRoom = null;

        // 채팅방 입장
        function enterRoom(roomName) {
            currentRoom = roomName;
            const chatHeader = document.getElementById('chatHeader');
            const chatContent = document.getElementById('chatContent');
            const chatRoom = document.getElementById('chatRoom');
            
            // 헤더 업데이트
            chatHeader.textContent = roomName;
            
            // 화면 전환
            chatContent.style.display = 'none';
            chatRoom.style.display = 'block';
            
            // 채팅방 목록에서 활성 상태 표시
            updateRoomSelection(roomName);
        }

        // 채팅방 선택 상태 업데이트
        function updateRoomSelection(activeRoom) {
            // 모든 채팅방에서 active 클래스 제거
            document.querySelectorAll('.room-list li').forEach(li => {
                li.classList.remove('active');
            });
            
            // 활성 채팅방에 active 클래스 추가
            document.querySelectorAll('.room-list li').forEach(li => {
                if (li.textContent === activeRoom) {
                    li.classList.add('active');
                }
            });
        }

        // 메시지 전송
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message && currentRoom) {
                addMessage(message, true); // 내 메시지
                messageInput.value = '';
                
                // 시연용: 1-3초 후 자동 응답
                setTimeout(() => {
                    const responses = [
                        '안녕하세요!',
                        '네, 맞습니다.',
                        '정말요?',
                        '흥미롭네요!',
                        '그렇군요.',
                        '좋은 생각이에요!'
                    ];
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    addMessage(randomResponse, false); // 상대방 메시지
                }, Math.random() * 2000 + 1000);
            }
        }

        // 메시지 추가
        function addMessage(text, isMe) {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `msg ${isMe ? 'me' : ''}`;
            
            messageDiv.innerHTML = `<div>${text}</div>`;
            
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        // 매칭 시작 시 가짜 방을 생성해 목록에 추가 (시안)
        function createRoom(listEl, label){
            if(!listEl) return null;
            const li = document.createElement('li');
            li.textContent = label;
            li.addEventListener('click', ()=>{ enterRoom(label); });
            listEl.appendChild(li);
            return li; // 생성된 요소 반환
        }
        
        // 메시지 전송 이벤트 리스너
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // 프로필 저장 시 관심사 목록 갱신
        window.addEventListener('storage', function(e) {
            if (e.key === 'isLoggedIn' && e.newValue === null) {
                // 로그아웃 시 익명카드 초기화
                const chat = document.getElementById('chat-ui');
                const setup = document.getElementById('anon-setup');
                chat.style.display = 'none';
                setup.style.display = 'block';
                // 폼 초기화
                document.getElementById('anon-form').reset();
                document.getElementById('ap_count').textContent = '0';
                document.getElementById('ap_nickname_count').textContent = '0';
                Array.from(document.querySelectorAll('.chip')).forEach(c => c.classList.remove('selected'));
                Array.from(document.querySelectorAll('[data-gender]')).forEach(b => b.classList.remove('active'));
                document.querySelector('[data-gender="남자"]').classList.add('active');
            }
            renderInterestList();
        });
        renderInterestList();
    });
    </script>
    <script src="script.js"></script>
</body>
</html>


